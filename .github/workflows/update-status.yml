name: "Update GitHub Status with ETH Daily Change"

on:
  schedule:
    # Runs every day at midnight UTC
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-status:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch current and previous ETH price
        id: price
        run: |
          # Get current ETH price
          CURRENT_PRICE=$(curl -s 'https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd' \
            | jq -r '.ethereum.usd')
          
          # Get ETH price from 24 hours ago
          PREV_PRICE=$(curl -s 'https://api.coingecko.com/api/v3/coins/ethereum/history?date=$(date -u -d "1 day ago" +%d-%m-%Y)' \
            | jq -r '.market_data.current_price.usd')
          
          # Calculate percentage change
          PERCENT_CHANGE=$(echo "scale=2; ($CURRENT_PRICE - $PREV_PRICE) / $PREV_PRICE * 100" | bc)
          
          # Format status (up/down emoji and change)
          if (( $(echo "$PERCENT_CHANGE > 0" | bc -l) )); then
            STATUS="ðŸ“ˆ ETH ${PERCENT_CHANGE}%"
          else
            STATUS="ðŸ“‰ ETH ${PERCENT_CHANGE}%"
          fi
          
          echo "::set-output name=status::$STATUS"

      - name: Update GitHub status
        run: |
          curl \
            -X POST \
            -H "Authorization: token ${{ secrets.USER_BIO_TOKEN }}" \
            -H "Content-Type: application/json" \
            https://api.github.com/user \
            -d "$(jq -n --arg status "${{ steps.price.outputs.status }}" '{status: {text: $status}}')"
